<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>WMF Flag Guess</title>
<style>
  :root { --bg:#ffffff; --ink:#0f172a; --muted:#64748b; --border:#e2e8f0; }
  * { box-sizing:border-box }
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
         margin:0; padding:24px; background:#fff; color:var(--ink) }
  h1 { margin:0 0 12px; font-size:24px }
  .wrap { max-width:1100px; margin:0 auto }
  .row { display:grid; grid-template-columns:1fr; gap:16px }
  @media (min-width:1000px){ .row { grid-template-columns:500px 1fr } }
  .card { border:1px solid var(--border); border-radius:16px; padding:16px; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.04) }
  input,button,label{ font-size:16px }
  input[type="text"]{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:12px }
  button{ padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#0f172a; color:#fff; cursor:pointer }
  button.ghost{ background:#fff; color:var(--ink) }
  table{ width:100%; border-collapse:collapse }
  th,td{ padding:8px; border-bottom:1px solid var(--border) }
  th{ text-align:left; background:#f8fafc }
  .hint{ font-size:14px; color:var(--muted) }
  .mapframe{ border:1px solid var(--border); border-radius:16px; overflow:hidden; position:relative }
  .toolbar{ position:absolute; right:12px; top:12px; display:flex; gap:8px }
  .toolbar button{ padding:6px 10px; border-radius:10px; font-size:14px }
  .flagpanel{ display:flex; align-items:center; gap:10px; padding:10px; border:1px solid var(--border); border-radius:12px; background:#f8fafc; flex-wrap:wrap }
  .flagbox{ display:flex; align-items:center; gap:8px; min-height:34px }
  .flagimg{ width:60px; height:40px; object-fit:cover; border-radius:6px; border:1px solid #cbd5e1; background:#fff }
  .flagemoji{ font-size:28px; line-height:1 }
  svg{ width:100%; height:auto; display:block; background:linear-gradient(180deg,#eef6ff,#fbfdff) }
  .sharebar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px }
  .toast{ font-size:14px; color:#065f46; background:#ecfdf5; border:1px solid #d1fae5; padding:6px 10px; border-radius:10px; display:none }
  .unit-toggle { display:flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:10px; background:#fff }
  .unit-toggle label { display:flex; align-items:center; gap:6px; font-size:14px; }
</style>
<script src="https://unpkg.com/d3@7"></script>
<script src="https://unpkg.com/topojson-client@3"></script>
</head>
<body>
<div class="wrap">
  <header style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <h1>WMF Flag Guess</h1>
    <div style="display:flex; gap:8px;">
      <button id="newGameBtn">New Game</button>
      <button id="giveUpBtn" class="ghost">Give up</button>
    </div>
  </header>

  <div class="row" style="margin-top:12px;">
    <section class="card">
      <h3>Make a guess</h3>

      <div class="flagpanel" style="margin-bottom:10px;">
        <label style="display:flex; align-items:center; gap:8px;">
          <input type="checkbox" id="flagToggle"/> Show flag automatically
        </label>

        <div class="unit-toggle" id="unitToggle">
          <span class="hint">Units:</span>
          <label><input type="radio" name="unit" value="km" checked> Km</label>
          <label><input type="radio" name="unit" value="mi"> Miles</label>
        </div>

        <button id="revealFlagBtn" class="ghost">Reveal Flag</button>
        <div id="flagBox" class="flagbox" aria-live="polite"></div>
        <span id="flagStatus" class="hint"></span>
        </div>
	<button onclick="document.getElementById('dishImage').style.display='block'">
	        Reveal Country Dish
	    </button>

    <img id="dishImage" src="dishes/japan_dish.jpg" width="300" style="display: none; margin-top: 10px;">

<script>
  const dishImages = [
    'japan_dish.jpg',
  ];

  function revealCountryDish() {
    const dishImageElement = document.getElementById('dishImage');
    dishImageElement.src = 'dishes/japan_dish.jpg';
    dishImageElement.style.display = 'block';
  }

  function newGameBtn() {
document.getElementById("newGameBtn").addEventListener("click",()=>{
  resetRound();
  pickNewTarget(); // will auto-show flag if checkbox is checked

  document.getElementById('dishImage').style.display = 'none';
});
  
  }

  function giveUpBtn() {
document.getElementById("giveUpBtn").addEventListener("click",()=>{
  if(!targetName || solved || gaveUp) return;
  gaveUp=true;
  statusEl.innerHTML="Gave up. Target was <b>"+targetName+"</b>.";
  updateSharePreview();

  document.getElementById('dishImage').style.display = 'none';
});
 
  }
window.addEventListener("DOMContentLoaded", () => {
    giveUpBtn();
    newGameBtn();
  });
</script>

      <form id="guessForm" style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
        <input id="guessInput" type="text" list="countries" placeholder="Type a country and press Enter‚Ä¶" autocomplete="off"/>
        <datalist id="countries"></datalist>
        <button>Guess</button>
      </form>

      <div id="status" class="hint">Loading map‚Ä¶</div>

      <div style="overflow:auto; border:1px solid var(--border); border-radius:12px;">
        <table id="guessesTable">
          <thead>
            <tr><th>#</th><th>Guess</th><th style="text-align:right;">Distance</th><th style="text-align:center;">Direction</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="sharebar">
        <button id="shareBtn" title="Share result">Share result</button>
        <button id="copyBtn" class="ghost" title="Copy result">Copy result</button>
        <span id="shareToast" class="toast">Copied!</span>
        <span id="sharePreview" class="hint"></span>
      </div>

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button id="clearBtn" class="ghost">Clear guesses</button>
        <span class="hint">Zoom with mouse/trackpad, drag to pan. Tiny countries draw as dots.</span>
      </div>
    </section>

    <section class="card">
      <h3>Map (zoomable, continents shown)</h3>
      <div class="mapframe">
        <div class="toolbar">
          <button id="zoomInBtn">+</button>
          <button id="zoomOutBtn">‚àí</button>
          <button id="resetBtn" class="ghost">Reset</button>
        </div>
        <svg id="map" viewBox="0 0 960 500" preserveAspectRatio="xMidYMid meet">
          <g id="viewport">
            <g id="graticule"></g>
            <g id="land"></g>
            <g id="guessed"></g>
          </g>
        </svg>
      </div>
    </section>
  </div>

  <footer class="hint">Uses D3 + TopoJSON (countries & land) + world-countries for ISO codes.</footer>
</div>

<script>
/* ---------- helpers ---------- */
function toRad(d){return d*Math.PI/180;}
function haversine(lat1,lon1,lat2,lon2){
  const R=6371,dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
  return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function bearing(lat1,lon1,lat2,lon2){
  const y=Math.sin(toRad(lon2-lon1))*Math.cos(toRad(lat2));
  const x=Math.cos(toRad(lat1))*Math.sin(toRad(lat2))-Math.sin(toRad(lat1))*Math.cos(toRad(lat2))*Math.cos(toRad(lon2-lon1));
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}
function arrowFromBearing(deg){
  const dirs=[{d:"‚Üë",min:337.5,max:360},{d:"‚Üë",min:0,max:22.5},{d:"‚Üó",min:22.5,max:67.5},{d:"‚Üí",min:67.5,max:112.5},
              {d:"‚Üò",min:112.5,max:157.5},{d:"‚Üì",min:157.5,max:202.5},{d:"‚Üô",min:202.5,max:247.5},
              {d:"‚Üê",min:247.5,max:292.5},{d:"‚Üñ",min:292.5,max:337.5}];
  return dirs.find(r=>deg>=r.min&&deg<r.max).d;
}
function heatColor(km){const max=20000,t=Math.max(0,Math.min(1,km/max));
  const r=Math.round(255*(1-t)),g=Math.round(90*(1-t)+60*t),b=Math.round(255*t);
  return `rgb(${r},${g},${b})`;
}
function normalize(s){
  if(!s) return "";
  s = s.replace(/\s*\(.*?\)\s*/g," ").trim().toLowerCase();
  s = s.normalize("NFD").replace(/[\u0300-\u036f]/g,"");
  s = s.replace(/‚Äô/g,"'").replace(/\s+/g," ");
  return s;
}
function emojiFlagFromA2(a2){
  if(!a2||a2.length!==2) return null;
  const base=0x1F1E6,A=a2.toUpperCase();
  return String.fromCodePoint(base+(A.charCodeAt(0)-65))+String.fromCodePoint(base+(A.charCodeAt(1)-65));
}

/* ---------- share squares: coldest ‚Üí hottest ---------- */
/*  ‚¨ú (>8000 km), üü¶ (4001‚Äì8000), üü® (1501‚Äì4000), üüß (501‚Äì1500), üü• (0‚Äì500) */
function squareForDistance(km){
  if(km<=500) return "üü•";
  if(km<=1500) return "üüß";
  if(km<=4000) return "üü®";
  if(km<=8000) return "üü¶";
  return "‚¨ú";
}

/* ---------- units ---------- */
let unit="km"; // default
const KM_TO_MI=0.621371;
function formatDistance(km){
  if(unit==="km") return `${km.toFixed(0)} km`;
  const mi=km*KM_TO_MI;
  return `${mi.toFixed(0)} mi`;
}

/* ---------- name fixes / territory codes / blocklist ---------- */
const ShortNameFix = {
  "Turks and Caicos Is.":"Turks and Caicos Islands","W. Sahara":"Western Sahara","Solomon Is.":"Solomon Islands",
  "Marshall Is.":"Marshall Islands","Fr. Polynesia":"French Polynesia","U.S. Virgin Is.":"United States Virgin Islands",
  "Faeroe Is.":"Faroe Islands","Heard I. and McDonald Is.":"Heard Island and McDonald Islands","Cayman Is.":"Cayman Islands",
  "Antigua and Barb.":"Antigua and Barbuda","St-Barth√©lemy":"Saint Barth√©lemy","N. Mariana Is.":"Northern Mariana Islands",
  "Vatican":"Vatican City","Ashmore and Cartier Is.":"Ashmore and Cartier Islands","Br. Indian Ocean Ter.":"British Indian Ocean Territory",
  "Dominican Rep.":"Dominican Republic","Wallis and Futuna Is.":"Wallis and Futuna","N. Cyprus":"Northern Cyprus",
  "St. Vin. and Gren.":"Saint Vincent and the Grenadines","Pitcairn Is.":"Pitcairn Islands","St. Kitts and Nevis":"Saint Kitts and Nevis",
  "St-Martin":"Saint Martin","Central African Rep.":"Central African Republic","Eq. Guinea":"Equatorial Guinea",
  "Bosnia and Herz.":"Bosnia and Herzegovina","Dem. Rep. Congo":"Democratic Republic of the Congo","S. Geo. and the Is.":"South Georgia and the South Sandwich Islands",
  "Solomon Is":"Solomon Islands","S. Sudan":"South Sudan","British Virgin Is.":"British Virgin Islands","Cook Is.":"Cook Islands",
  "Fr. S. Antarctic Lands":"French Southern Territories","Cabo Verde":"Cape Verde","Macedonia":"North Macedonia"
};
const TerritoryA2 = {
  "south georgia and the south sandwich islands":"GS","new caledonia":"NC","french southern territories":"TF","bouvet island":"BV",
  "heard island and mcdonald islands":"HM","western sahara":"EH","turks and caicos islands":"TC","solomon islands":"SB","marshall islands":"MH",
  "french polynesia":"PF","united states virgin islands":"VI","faroe islands":"FO","cayman islands":"KY","saint barth√©lemy":"BL","saint barthelemy":"BL",
  "northern mariana islands":"MP","british indian ocean territory":"IO","wallis and futuna":"WF","pitcairn islands":"PN","saint kitts and nevis":"KN",
  "saint martin":"MF","vatican city":"VA","antigua and barbuda":"AG","dominican republic":"DO","central african republic":"CF","equatorial guinea":"GQ",
  "bosnia and herzegovina":"BA","democratic republic of the congo":"CD","saint vincent and the grenadines":"VC","british virgin islands":"VG",
  "south sudan":"SS","cook islands":"CK","cape verde":"CV","north macedonia":"MK"
};
const NoISO = new Set(["northern cyprus","ashmore and cartier islands","somaliland","siachen glacier"]);
const Blocklist = new Set(["siachen glacier","cabo verde","s. sudan","british virgin is.","macedonia",
                           "cook is.","northern cyprus","somaliland","fr. s. antarctic lands"]);

/* ---------- state ---------- */
let byName=new Map(), centroids=new Map(), countryNames=[], nameToA2=new Map();
let targetName=null, targetA2=null;
let guesses=[];          // chronological for sharing: {name, distance(km), bearing}
let attempts=0, solved=false, gaveUp=false;

/* ---------- map ---------- */
const svg=d3.select("#map"), viewport=svg.select("#viewport");
const gGraticule=svg.select("#graticule"), gLand=svg.select("#land"), gGuessed=svg.select("#guessed");
const projection=d3.geoNaturalEarth1().fitExtent([[10,10],[950,490]],{type:"Sphere"});
const path=d3.geoPath(projection), grat=d3.geoGraticule10();
gGraticule.append("path").attr("d",path(grat)).attr("fill","none").attr("stroke","#cfe3ff").attr("stroke-width",0.8);
const zoom=d3.zoom().scaleExtent([1,8]).translateExtent([[0,0],[960,500]]).on("zoom",ev=>viewport.attr("transform",ev.transform));
svg.call(zoom);
document.getElementById("zoomInBtn").onclick=()=>svg.transition().call(zoom.scaleBy,1.3);
document.getElementById("zoomOutBtn").onclick=()=>svg.transition().call(zoom.scaleBy,1/1.3);
document.getElementById("resetBtn").onclick=()=>svg.transition().call(zoom.transform,d3.zoomIdentity);

/* ---------- DOM ---------- */
const statusEl=document.getElementById("status");
const flagStatus=document.getElementById("flagStatus");
const flagToggle=document.getElementById("flagToggle");
const flagBox=document.getElementById("flagBox");
const tbody=document.querySelector("#guessesTable tbody");
const input=document.getElementById("guessInput");
const shareBtn=document.getElementById("shareBtn");
const copyBtn=document.getElementById("copyBtn");
const shareToast=document.getElementById("shareToast");
const sharePreview=document.getElementById("sharePreview");

/* ---------- data ---------- */
Promise.all([
  fetch("https://unpkg.com/world-atlas@2/land-50m.json").then(r=>r.json()),
  fetch("https://unpkg.com/world-atlas@2/countries-50m.json").then(r=>r.json()),
  fetch("https://unpkg.com/world-countries@4/countries.json").then(r=>r.json())
]).then(([landTopo,countriesTopo,wcountries])=>{
  wcountries.forEach(c=>{
    const a2=(c.cca2||"").toUpperCase(); if(a2.length!==2) return;
    const names=new Set([c.name?.common,c.name?.official, ...(c.altSpellings||[])]);
    names.forEach(n=>{ if(n) nameToA2.set(normalize(n),a2); });
  });
  Object.entries(TerritoryA2).forEach(([n,code])=>nameToA2.set(normalize(n),code));

  const land=topojson.feature(landTopo, landTopo.objects.land);
  gLand.append("path").datum(land).attr("d", path).attr("fill","#f5f7fb").attr("stroke","#cbd5e1");

  const coll=topojson.feature(countriesTopo, countriesTopo.objects.countries);
  function displayNameFromProps(p){
    const raw = p.NAME_LONG||p.name_long||p.FORMAL_EN||p.formal_en||p.NAME||p.name||p.ADMIN||p.admin||null;
    if(!raw) return null;
    return ShortNameFix[raw] || raw;
  }
  coll.features.forEach(f=>{
    const disp=displayNameFromProps(f.properties||{}); if(!disp) return;
    const nkey=normalize(disp);
    let a2 = nameToA2.get(nkey) || TerritoryA2[nkey] || null;
    if(NoISO.has(nkey)) a2=null;
    f._display=disp; f._a2=a2;
    byName.set(disp.toLowerCase(), f);
    centroids.set(disp, d3.geoCentroid(f));
  });

  countryNames=[...byName.values()].map(f=>f._display).sort((a,b)=>a.localeCompare(b));
  const dl=document.getElementById("countries"); dl.innerHTML="";
  countryNames.forEach(n=>{ const o=document.createElement("option"); o.value=n; dl.appendChild(o); });

  pickNewTarget();
  statusEl.textContent="Map ready. Guess a country!";
}).catch(err=>{ console.error(err); statusEl.textContent="Failed to load map data."; });

/* ---------- UI ---------- */
document.getElementById("guessForm").addEventListener("submit",(e)=>{
  e.preventDefault();
  const name=(input.value||"").trim();
  if(!name || solved || gaveUp) return;
  handleGuess(name);
  input.value=""; input.focus();
});
document.getElementById("newGameBtn").addEventListener("click",()=>{
  resetRound();
  pickNewTarget(); // will auto-show flag if checkbox is checked
});
document.getElementById("giveUpBtn").addEventListener("click",()=>{
  if(!targetName || solved || gaveUp) return;
  gaveUp=true;
  statusEl.innerHTML="Gave up. Target was <b>"+targetName+"</b>.";
  updateSharePreview();
});

document.getElementById("clearBtn").addEventListener("click",()=>{ guesses=[]; tbody.innerHTML=""; gGuessed.selectAll("*").remove(); });
document.getElementById("revealFlagBtn").addEventListener("click",()=> updateFlagPanel("shown"));
flagToggle.addEventListener("change",()=> updateFlagPanel(flagToggle.checked?"auto":"hidden"));
document.getElementById("unitToggle").addEventListener("change",(e)=>{
  const v = [...document.querySelectorAll('input[name="unit"]')].find(r=>r.checked)?.value || "km";
  unit = (v==="mi") ? "mi" : "km";
  updateTable(); // refresh numbers in table
  // also refresh status ‚Äúclosest so far‚Äù
  if(guesses.length && !solved && !gaveUp){
    const best = closestGuess();
    statusEl.innerHTML=`Closest so far: <b>${best.name}</b> (${formatDistance(best.distance)})`;
  }
});

shareBtn.addEventListener("click", async ()=>{
  const text=buildShareText();
  if(navigator.share){ try{ await navigator.share({ text }); }catch(e){} }
  else { await copyToClipboard(text); flashToast(); }
});
copyBtn.addEventListener("click", async ()=>{ await copyToClipboard(buildShareText()); flashToast(); });

/* ---------- clipboard + toast ---------- */
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); }
  catch(e){
    const ta=document.createElement("textarea");
    ta.value=text; document.body.appendChild(ta); ta.select();
    try{ document.execCommand("copy"); }catch(_){}
    document.body.removeChild(ta);
  }
}
function flashToast(){ shareToast.style.display="inline-block"; setTimeout(()=>shareToast.style.display="none", 1400); }

/* ---------- flags ---------- */
function renderSingleFlag(a2){
  const box=flagBox; box.innerHTML=""; flagStatus.textContent="";
  if(!a2){ flagStatus.textContent="No flag available."; return; }
  const img=document.createElement("img");
  img.className="flagimg"; img.alt="Flag"; img.referrerPolicy="no-referrer"; img.loading="lazy";
  img.src="https://flagcdn.com/w80/"+a2.toLowerCase()+".png";
  img.onerror=()=>{
    const emoji=emojiFlagFromA2(a2);
    box.innerHTML="";
    if(emoji){ const span=document.createElement("span"); span.className="flagemoji"; span.textContent=emoji; box.appendChild(span); }
    else { flagStatus.textContent="No flag available."; }
  };
  box.appendChild(img);
}
function updateFlagPanel(mode){
  flagBox.innerHTML=""; flagStatus.textContent="";
  if(mode==="hidden") return;
  renderSingleFlag(targetA2);
}

/* ---------- round control ---------- */
function resetRound(){
  guesses=[]; attempts=0; solved=false; gaveUp=false;
  tbody.innerHTML=""; gGuessed.selectAll("*").remove();
  flagBox.innerHTML=""; flagStatus.textContent="";
  sharePreview.textContent=""; shareToast.style.display="none";
  svg.transition().call(zoom.transform,d3.zoomIdentity);
}

/* ---------- target selection (respects blocklist) ---------- */
function pickNewTarget(){
  if(countryNames.length===0){ targetName=null; targetA2=null; return; }
  let choice, tries=0;
  do { choice = countryNames[Math.floor(Math.random()*countryNames.length)]; tries++; if(tries>2000) break; }
  while (Blocklist.has(choice.toLowerCase()));
  targetName=choice;
  const f=byName.get(targetName.toLowerCase());
  targetA2=f?f._a2:null;
  updateFlagPanel(flagToggle.checked ? "auto" : "hidden");
}

/* ---------- gameplay ---------- */
function drawGuessed(f,km){
  const b=path.bounds(f); const w=Math.max(0,b[1][0]-b[0][0]), h=Math.max(0,b[1][1]-b[0][1]);
  const tiny=(w*h<6)||(w<2&&h<2);
  if(tiny){
    const pt=projection(d3.geoCentroid(f));
    gGuessed.append("circle").attr("cx",pt[0]).attr("cy",pt[1]).attr("r",4).attr("fill",heatColor(km)).attr("stroke","#0f172a").attr("stroke-width",0.8);
  } else {
    gGuessed.append("path").datum(f).attr("d",path).attr("fill",heatColor(km)).attr("stroke","#0f172a").attr("stroke-width",0.6);
  }
}
function handleGuess(name){
  const idxExact = countryNames.findIndex(n=>n.toLowerCase()===name.toLowerCase());
  const real = idxExact>=0 ? countryNames[idxExact] : countryNames.find(n=>n.toLowerCase().startsWith(name.toLowerCase()));
  if(!real){ statusEl.textContent="I don't know that country."; return; }
  if(solved || gaveUp){ return; }

  const f=byName.get(real.toLowerCase()); if(!f){ statusEl.textContent="Couldn't draw that country."; return; }
  const cG=centroids.get(real), cT=centroids.get(targetName); if(!cG||!cT){ statusEl.textContent="Missing centroid."; return; }

  const d=haversine(cG[1],cG[0],cT[1],cT[0]);
  const br=bearing(cG[1],cG[0],cT[1],cT[0]);

  attempts++;
  guesses.push({name:real,distance:d,bearing:br}); // keep chronological for sharing
  drawGuessed(f,d); updateTable();

  const best = closestGuess();
  if(real===targetName){
    solved=true;
    statusEl.innerHTML=`üéâ Correct! You solved it in <b>${attempts}</b> guess${attempts>1?"es":""}. The country was <b>${targetName}</b>.`;
    updateSharePreview();
  } else {
    statusEl.innerHTML=`Closest so far: <b>${best.name}</b> (${formatDistance(best.distance)})`;
  }
}
function closestGuess(){
  return guesses.reduce((best,g)=> g.distance<best.distance?g:best, guesses[0]);
}
function updateTable(){
  const display = [...guesses].sort((a,b)=>a.distance-b.distance); // closest on top
  tbody.innerHTML="";
  display.forEach((g,i)=>{
    const tr=document.createElement("tr");
    tr.style.background="linear-gradient(90deg,"+heatColor(g.distance)+"22, transparent)";
    tr.innerHTML=`<td>${i+1}</td><td>${g.name}</td><td style="text-align:right">${formatDistance(g.distance)}</td><td style="text-align:center">${arrowFromBearing(g.bearing)}</td>`;
    tbody.appendChild(tr);
  });
}

/* ---------- sharing ---------- */
function buildShareText(){
  const title = solved
    ? `üåç Flag Guess ‚Äî Solved in ${attempts} guess${attempts>1?"es":""} (${unit})`
    : (gaveUp ? `üåç WMF Flag Guess ‚Äî I tried! (${unit})` : `üåç WMF Flag Guess (${unit})`);

  const blocks = guesses.map(g=> squareForDistance(g.distance)).join(""); // chronological squares
  const arrows = guesses.map(g=> arrowFromBearing(g.bearing)).join(" ");
  const details = solved ? `Answer: ${targetName}` : (gaveUp ? `Gave up. Answer: ${targetName}` : `Answer hidden`);
  const stamp = new Date().toLocaleDateString(undefined,{year:"numeric",month:"short",day:"numeric"});
  return `${title}\n${blocks}\n${arrows}\n${details}\n${stamp}`;
}
function updateSharePreview(){
  const firstLine = buildShareText().split("\n")[0];
  sharePreview.textContent = firstLine + " ‚Äî ready to share!";
}

/* ---------- copy helper ---------- */
async function copyToClipboard(text){
  try{ await navigator.clipboard.writeText(text); }
  catch(e){
    const ta=document.createElement("textarea");
    ta.value=text; document.body.appendChild(ta); ta.select();
    try{ document.execCommand("copy"); }catch(_){}
    document.body.removeChild(ta);
  }
}
function flashToast(){ shareToast.style.display="inline-block"; setTimeout(()=>shareToast.style.display="none", 1400); }
</script>
</body>
</html>